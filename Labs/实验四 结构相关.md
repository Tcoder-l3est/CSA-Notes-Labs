# 实验四 结构相关

> 实验信息
>
> 姓名： 	张朝阳			班级： 19.1
>
> 学号：	201900180091      时间：2022.5.10
>

## 实验目的

通过本实验，加深对结构相关的理解，了解结构相关对 CPU 性能的影响。

## 实验环境

操作系统：Windows XP

软件环境：WinDLX

CPU: Intel(R) Core(TM) i5-8300H CPU @ 2.30GHz   2.30 GHz

## 实验内容

- 用 WinDLX 模拟器运行程序 structure_d.s 。 
- 通过模拟，找出存在结构相关的指令对以及导致结构相关的部件。 
- 记录由结构相关引起的暂停时钟周期数，计算暂停时钟周期数占总执行周期数的百分比。
- 论述结构相关对 CPU 性能的影响，讨论解决结构相关的方法。

## 实验步骤

load structure_d.s 文件，单步运行，此程序一次循环当中有五次结构相关(Stall)

### 结构相关

#### 第一个结构相关

因为上一条add f0,f0,f4 存在数据相关，导致存在R-Stall 再译码阶段，然后当指令add f2,f0,f2需要进行译码的时候，必须等待add f0,f0,f4，导致了结构相关，**相关的部件是译码部件**。

![image-20220516174619851](https://vvtorres.oss-cn-beijing.aliyuncs.com/image-20220516174619851.png)

#### 第二个结构相关

由于add f2 f0 f2 在ID 阶段发生了R-stall，导致addi r2,r2,0x8 在译码阶段需要等待译码器，也发生了结构相关。**译码器的结构相关**。

![image-20220516175217664](https://vvtorres.oss-cn-beijing.aliyuncs.com/image-20220516175217664.png)

#### 第三个结构相关

还是在addi r2,r2,0x8 发生了结构相关；具体在执行阶段到访存阶段时，因为上一条需要方寸，所以存在**存储器的结构相关冲突**。

![image-20220516174429154](https://vvtorres.oss-cn-beijing.aliyuncs.com/image-20220516174429154.png)

#### 第四个结构相关

addi R3,R3,0x8 中发生了结构相关

因为上面的add r2 r2 0x8 在执行阶段进行stall，导致下面addi r3 r3 0x8 只能在译码阶段进行stall

**为执行部件ALU的结构相关**

![image-20220516191954560](https://vvtorres.oss-cn-beijing.aliyuncs.com/image-20220516191954560.png)

#### 第五个结构相关

SUB R5, R4, R2的取指阶段

因为上一条addi 在译码阶段stall了所以 该sub 只能在取指阶段stall

**是译码部件结构相关**

![image-20220516192728418](https://vvtorres.oss-cn-beijing.aliyuncs.com/image-20220516192728418.png)



#### 暂停时钟周期数

运行结束，查看statistics，如下，总共139个周期，程序一共循环10次，每次有5个结构相关，但后三个在同一时钟周期发生，一次相关暂停一个周期，所以，其实是每次循环有三个周期因为结构相关暂停了。

暂停时钟周期数占总执行周期数的百分比为：**3*10/139=21.58%**

![image-20220516193827388](https://vvtorres.oss-cn-beijing.aliyuncs.com/image-20220516193827388.png)



#### 论述结构相关对CPU性能的影响，讨论解决结构相关的方法

发生结构相关时，必然会导致流水线效率的降低，如果处理不当甚至会发生错误。解决的方法主要有：

（1）流水化功能单元；（2）资源重复；（3）暂停流水线。(4) 也可以将 Cache 分割成指令 Cache 和数据 Cache。

## 源码阅读

 structure_d.s 代码以及注释如下：

```assembly
;-----------------------------------------------------------------
; 循环十次，测试结构相关
;-----------------------------------------------------------------
      LHI      R2, (A>>16)&0xFFFF   ; 载入A的高16位到R2高16位
      ADDUI    R2, R2, A&0xFFFF     ; 无符号立即数加A的低十六位
      LHI      R3, (B>>16)&0xFFFF   ; B的高16位到R3的高16位
      ADDUI    R3, R3, B&0xFFFF     ; 无符号立即数加B的低十六位
      ADDU     R4, R0, R3           ; R4 = R0 + R3，即等于B的地址
loop:  
      LD     F0, 0(R2)              ; F0 = A[0]
      LD     F4, 0(R3)              ; F4 = B[0]
      ADDD   F0, F0, F4             ; F0 = F0 + F4
      ADDD   F2, F0, F2             ; F2 = F0 + F2,存在译码器的结构相关
      ADDI   R2, R2, #8             ; r2 指向下个单元,存在译码器、存储器的结构相关
      ADDI   R3, R3, #8             ; r3 指向下个单元,存在ALU的结构相关冲突
      SUB    R5, R4, R2             ; r5 = r4 - r2,存在译码部件结构相关
      BNEZ   R5, loop               ; R5 = 0 时退出循环，否则继续loop
      TRAP   #0                     ; Exit <- this is a comment !! 
A:    .double 1, 2, 3, 4, 5, 6, 7, 8, 9, 10  
B:    .double 1, 2, 3, 4, 5, 6, 7, 8, 9, 10  

```



## 涉及指令

 structure_d.s 所使用的部分DLX指令如下

|                   指令                   |                     含义                     |
| :--------------------------------------: | :------------------------------------------: |
|          LHI R2,(A>>16)&0XFFFF           | 将立即数(A>>16)&0XFFFF载入到寄存器R2的高16位 |
|          ADDUI R3, R3, B&0xFFFF          |                无符号立即数加                |
|             ADDD F0, F0, F4              |                 双精度浮点加                 |
|             ADDI R2, R2, #8              |                 整数立即数加                 |
| A: .double 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 |          double 类型 A数组，A为地址          |

## 实验心得

1. 在第三个结构相关中，虽然DLX流水线显示进行Mem阶段，并且有存储器的结构相关，但是实际上因为是对寄存器的操作，但其实在Mem阶段什么都没有做，并没有访问存储器的。
1. 本次实验主要是通过具体的程序实例向我们展示了流水线中的结构相关冲突。通过本次实验，更加深刻地认识了结构相关是怎么发生的，包括流水线单步执行、每个流水段功能、流水线建立与排空、定向技术等内容有了很好的掌握；知道其运行情况，以及结构相关在此程序中导致的延迟。
1. 假设不考虑流水线其它因素对流水线性能的影响，显然如果流水线机器没有结构相关，那么 其 CPI 也较小。然而，为什么有时流水线设计者却允许结构相关的存在呢？主要有两个原因： 一是为了减少硬件代价，二是为了减少功能单元的延迟。如果为了避免结构相关而将流水线中的 所有功能单元完全流水化，或者设置足够的硬件资源，那么所带来的硬件代价必定很大。
